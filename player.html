<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Spotify Web Player</title>
  <script src="https://sdk.scdn.co/spotify-player.js"></script>
</head>
<body>
  <h2>Spotify Web Player</h2>
  <p id="status">Loading Web Playback SDK...</p>
  <button id="playPauseBtn" disabled onclick="togglePlay()">Play/Pause</button>
  <button id="nextBtn" disabled onclick="nextTrack()">Next</button>
  <button id="prevBtn" disabled onclick="prevTrack()">Previous</button>

  <script>
    const params = new URLSearchParams(window.location.search);
    const token = params.get('access_token');
    let deviceId = null;
    let player = null;
    let controlsEnabled = false;

    window.onSpotifyWebPlaybackSDKReady = () => {
      player = new Spotify.Player({
        name: 'Android Web Player',
        getOAuthToken: cb => cb(token),
        volume: 0.8
      });

      player.addListener('ready', ({ device_id }) => {
        deviceId = device_id;
        document.getElementById('status').innerText = "âœ… Player ready: " + deviceId;
        console.log("âœ… Player Ready:", deviceId);

        if (window.AndroidInterface && AndroidInterface.onPlayerReady) {
          AndroidInterface.onPlayerReady(deviceId);
        }

        startPlayback();
      });

      player.addListener('not_ready', ({ device_id }) => {
        document.getElementById('status').innerText = "âŒ Player not ready: " + device_id;
        console.warn("Player not ready:", device_id);
      });

      player.addListener('initialization_error', e => {
        console.error("Initialization error:", e.message);
      });

      player.addListener('authentication_error', e => {
        console.error("Authentication error:", e.message);
      });

      player.addListener('account_error', e => {
        console.error("Account error:", e.message);
      });

      player.addListener('playback_error', e => {
        console.error("Playback error:", e.message);
      });

      player.connect();
      window.player = player;
    };

    function startPlayback() {
      fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
        method: "PUT",
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          uris: ["spotify:track:7ouMYWpwJ422jRcDASZB7P"] // your default song
        })
      }).then(res => {
        if (res.ok) {
          document.getElementById('status').innerText = "ðŸŽµ Playing";
          enableControls();
        } else {
          console.error("Playback failed:", res.statusText);
          document.getElementById('status').innerText = "âŒ Failed to play";
        }
      });
    }

    function enableControls() {
      controlsEnabled = true;
      ['playPauseBtn', 'nextBtn', 'prevBtn'].forEach(id => {
        document.getElementById(id).disabled = false;
      });
    }

    function togglePlay() {
      if (controlsEnabled) player.togglePlay();
    }

    function nextTrack() {
      if (controlsEnabled) player.nextTrack();
    }

    function prevTrack() {
      if (controlsEnabled) player.previousTrack();
    }
  </script>
</body>
</html>
