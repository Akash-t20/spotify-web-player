<!DOCTYPE html>
<html>
<head>
    <title>Spotify Player</title>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
</head>
<body>
<h1>Spotify Player</h1>
<div id="status">Loading...</div>
<button id="playPauseBtn" onclick="playPause()" disabled>Play/Pause</button>
<button id="nextBtn" onclick="next()" disabled>Next</button>
<button id="prevBtn" onclick="previous()" disabled>Previous</button>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('access_token');  // Get access token from URL

    let device_id = '';
    let player;
    let playbackLoaded = false;

    window.onSpotifyWebPlaybackSDKReady = () => {
        player = new Spotify.Player({
            name: 'My Android Web Player',
            getOAuthToken: cb => { cb(token); },
            volume: 0.5
        });

        player.addListener('ready', ({ device_id: id }) => {
            device_id = id;
            console.log("‚úÖ Player ready with device_id:", device_id);
            document.getElementById('status').innerText = "Player ready: " + device_id;

            // üîÅ Inform Android app via JS interface
            if (window.AndroidInterface && AndroidInterface.onPlayerReady) {
                console.log("üì° Sending device_id to AndroidInterface...");
                AndroidInterface.onPlayerReady(device_id);
            } else {
                console.log("‚ö†Ô∏è AndroidInterface.onPlayerReady is not available");
            }

            // Start playback
            fetch(`https://api.spotify.com/v1/me/player/play?device_id=${device_id}`, {
                method: "PUT",
                body: JSON.stringify({
                    uris: ["spotify:track:7ouMYWpwJ422jRcDASZB7P"]  // Replace URI as needed
                }),
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                }
            }).then(response => {
                if (response.ok) {
                    console.log("‚úÖ Playback started");
                    playbackLoaded = true;
                    document.getElementById('playPauseBtn').disabled = false;
                    document.getElementById('nextBtn').disabled = false;
                    document.getElementById('prevBtn').disabled = false;
                } else {
                    console.error('‚ùå Failed to start playback:', response.statusText);
                }
            });
        });

        player.addListener('not_ready', ({ device_id }) => {
            document.getElementById('status').innerText = "Player not ready: " + device_id;
            console.warn("‚ö†Ô∏è Player not ready:", device_id);
        });

        player.addListener('initialization_error', ({ message }) => {
            console.error('‚ùå Initialization Error:', message);
        });

        player.addListener('authentication_error', ({ message }) => {
            console.error('‚ùå Authentication Error:', message);
        });

        player.addListener('account_error', ({ message }) => {
            console.error('‚ùå Account Error:', message);
        });

        player.addListener('playback_error', ({ message }) => {
            console.error('‚ùå Playback Error:', message);
        });

        player.connect();
        window.player = player;
    };

    function playPause() {
        if (player && playbackLoaded) {
            player.togglePlay();
        } else {
            alert('Playback not ready yet. Please wait.');
        }
    }

    function next() {
        if (player && playbackLoaded) {
            player.nextTrack();
        } else {
            alert('Playback not ready yet. Please wait.');
        }
    }

    function previous() {
        if (player && playbackLoaded) {
            player.previousTrack();
        } else {
            alert('Playback not ready yet. Please wait.');
        }
    }
</script>
</body>
</html>
